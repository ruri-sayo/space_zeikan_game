# Audit H680k 実装企画書（v0.1 / コーディング着手版）

## 1. 目的とスコープ

### 1.1 プロダクト目的
太平洋上宇宙港「H680k」の税関監査官として、プレイヤーが **証言・物理データ・生命科学データ** を突き合わせて矛盾を検出し、最終判定（CLEAR / SECONDARY AUDIT / DETAIN）を下す1案件完結型の監査ゲームを提供する。

### 1.2 v0の到達目標（Definition of Done）
- ブラウザで動く単一ページUI（Astro + React）を実装。
- 10案件（固定データ）をローカルJSONから読み込み、順にプレイ可能。
- 各案件で以下が動作すること。
  - 証言矛盾の検出（論理ルールベース）
  - 物理矛盾の検出（軌道・密度・熱の少なくとも3系統）
  - 生命科学矛盾の検出（同位体/免疫・DNAマーカーの少なくとも1系統）
- 判定ボタン押下でスコア計算と結果表示。
- ブログ埋め込み可能なiframe前提レイアウト（レスポンシブ最小対応）。

### 1.3 v0でやらないこと（Non-goals）
- サーバー保存、ユーザーアカウント、ランキング。
- 生成AIによるリアルタイム証言生成（v0は事前生成済み固定ログ）。
- 多言語対応。
- 3D高精細モデル制作（v0は簡易ワイヤーフレーム）。

---

## 2. ターゲット体験

### 2.1 プレイ時間
- 1案件: 5〜12分
- 10案件通し: 90分程度

### 2.2 コアループ（1案件）
1. 案件概要確認（30秒）
2. 左パネルで申告書・スペック表を確認
3. 中央で可視化（軌道・波形・船体断面）を切替確認
4. 右パネルで証言ログを読み、矛盾タグを付与
5. 「監査メモ」に気づきを記録（任意）
6. 判定ボタン押下
7. 正答・誤答理由と学習ポイント表示

### 2.3 失敗/成功定義
- 成功: 正しい判定を選び、かつ主要矛盾（案件ごとに2〜4件）を70%以上検出。
- 部分成功: 判定は正しいが、矛盾検出率が70%未満。
- 失敗: 判定が誤り。

---

## 3. ゲームデザイン詳細

### 3.1 判定ロジック
- **CLEAR**: 重大矛盾なし（critical contradiction = 0）
- **SECONDARY AUDIT**: 軽微〜中程度矛盾あり（critical 0 かつ warning >= 1）
- **DETAIN**: 重大矛盾1件以上

### 3.2 矛盾の重み
- `critical`: 5点
- `warning`: 2点
- `info`: 1点

### 3.3 スコア
- 検出スコア = プレイヤーがタグ付けした矛盾の正答重み合計 / 案件総重み
- 判定スコア = 判定一致で +30, 不一致で 0
- 最終スコア = 検出スコア(0-70) + 判定スコア(0 or 30)

---

## 4. 案件データ仕様（JSON固定）

### 4.1 ファイル配置
- `/src/data/cases/case-001.json` 〜 `case-010.json`
- `/src/data/cases/index.json`（並び順、難易度、表示名）

### 4.2 1案件のスキーマ
```json
{
  "id": "case-001",
  "title": "軌道ログの寄り道",
  "difficulty": 1,
  "brief": "L1補給ステーション経由申告の貨物船...",
  "documents": {
    "manifest": { "massKg": 12000, "volumeM3": 42, "material": "Al-2219" },
    "route": { "from": "Hilo", "to": "H680k", "etaHours": 19.5 },
    "power": { "idleKw": 42 }
  },
  "telemetry": {
    "orbit": { "expectedDv": 3120, "actualDv": 3770 },
    "vibration": { "peaksHz": [32, 64, 129] },
    "thermal": { "radiatorKw": 77 }
  },
  "bio": {
    "isotope": { "expected": "PacificBand-3", "actual": "EurasiaBand-1" },
    "dnaMarkers": ["MKR-12", "MKR-44"]
  },
  "interviews": [
    { "id": "w1", "speaker": "Captain", "text": "直行した。補給寄港はない。" },
    { "id": "w2", "speaker": "Engineer", "text": "冷却系は待機時40kW未満。" }
  ],
  "truth": {
    "requiredVerdict": "DETAIN",
    "contradictions": [
      {
        "id": "c-orbit-01",
        "layer": "physics",
        "severity": "critical",
        "evidenceRefs": ["documents.route", "telemetry.orbit"],
        "rule": "actualDv > expectedDv * 1.15"
      }
    ]
  }
}
```

### 4.3 案件作成ガイド
- 各案件は「主矛盾1つ + 補助矛盾2つ」を最低構成にする。
- 10案件のうち
  - 4件: 物理主導
  - 3件: 論理証言主導
  - 3件: 生命科学主導
- 難易度1〜5を均等に配置（2件ずつ）。

---

## 5. 監査エンジン仕様

### 5.1 論理矛盾（証言）
- 方式: JSON-Logic + 事前定義述語
- 述語例
  - `sameTime(A, B)`
  - `exclusive(A, B)`（同時に真になれない）
  - `supports(A, B)`（整合する）
- 出力
  - `contradictionFlags: [{id, severity, reason, refs}]`

### 5.2 物理矛盾
実装必須関数（TypeScriptユーティリティ）:
- `calcDensity(massKg, volumeM3): number`
- `isDensityMismatch(actual, declaredMaterial): boolean`
- `isDvAnomaly(expectedDv, actualDv, threshold=0.15): boolean`
- `isThermalMismatch(idleKw, radiatorKw, allowance=0.2): boolean`

判定基準（v0固定）:
- 密度乖離: 材料公称密度から ±12%以上でwarning、±20%以上でcritical
- Δv乖離: 理論値比 +15%以上でcritical
- 熱収支: 待機電力比 +20%以上でwarning、+50%以上でcritical

### 5.3 生命科学矛盾
実装必須:
- `matchIsotopeBand(history, actualBand)`
- `validateDnaMarkers(declaredSpecies, markers)`

判定基準:
- 渡航履歴帯と同位体帯不一致: warning
- 危険マーカー（ブラックリスト）含有: critical

---

## 6. UI/UX実装仕様

### 6.1 画面構成
- `AppShell`
  - `HeaderBar`（案件名、難易度、進捗）
  - `LeftDocumentsPanel`
  - `CenterVisualizerPanel`
  - `RightInterviewActionPanel`
  - `ResultModal`

### 6.2 中央パネルのタブ
- `Hull`（Three.jsワイヤーフレーム + 回転）
- `Orbit`（Canvasで予定軌道/実測軌道重ね描き）
- `Signal`（周波数ピーク棒グラフ）
- `Bio`（同位体帯ヒートマップ簡易表示）

### 6.3 操作要件
- 証言行ごとに「疑わしい」トグル。
- 可視化上の異常点クリックで自動的に監査メモへ追記。
- 判定ボタンは確認ダイアログを挟む。

### 6.4 埋め込み要件
- iframe想定サイズ: `min 960x540`
- 960未満は2カラム（左+中央 / 右）に自動崩し。

---

## 7. フロントエンド設計

### 7.1 ディレクトリ構成（提案）
```txt
src/
  components/
    layout/
    panels/
    visualizers/
    modals/
  data/
    cases/
  engine/
    logic/
    physics/
    bio/
    scoring/
  stores/
    auditStore.ts
  types/
    case.ts
  pages/
    index.astro
```

### 7.2 状態管理（Zustand）
保持する状態:
- 現在案件ID
- 証言タグ付け状態
- 検出済み矛盾ID
- 判定選択
- スコア
- UIタブ状態

主要アクション:
- `loadCase(id)`
- `toggleInterviewFlag(lineId)`
- `markContradiction(contradictionId)`
- `submitVerdict(verdict)`
- `nextCase()`

### 7.3 型定義方針
- `CaseData`, `Contradiction`, `Verdict`, `Severity` を厳密型で定義。
- JSON読み込み時に `zod` でバリデーション（開発時エラー検出）。

---

## 8. コンテンツ制作仕様（10案件）

### 8.1 案件テンプレート
各案件は以下を必須入力:
- あらすじ（100〜180字）
- 申告データ（表形式）
- テレメトリ（数値）
- 証言3〜6本
- 正答判定
- 主要矛盾2〜4件
- 解説テキスト（なぜ矛盾か）

### 8.2 難易度設計
- 難易度1: 単一矛盾が明確
- 難易度2: 補助矛盾がノイズとして混ざる
- 難易度3: レイヤー跨ぎの照合が必要
- 難易度4: 2段推論（A→B→C）
- 難易度5: 複合矛盾 + 誘導フェイク証言あり

### 8.3 テキストトーン
- ハードSF調、官僚監査ログ風。
- 1証言は最大120文字。
- 数値はSI単位を原則。

---

## 9. 開発タスク分解（2週間想定）

### Week 1
1. プロジェクト雛形作成（Astro + React + Zustand + R3F）
2. 型定義・データスキーマ・zodバリデータ実装
3. 監査エンジン（logic/physics/bio/scoring）実装
4. 1案件分の縦切り実装（UI〜判定まで通す）

### Week 2
5. 可視化4タブ実装
6. 案件データ10件投入
7. 難易度調整・閾値調整
8. 結果画面・案件遷移・最終集計実装
9. E2Eテスト（主要導線）
10. ブログ埋め込み検証

---

## 10. テスト計画

### 10.1 ユニットテスト（Vitest想定）
- 物理関数の境界値テスト
- JSON-Logicルールの真偽テスト
- スコア計算テスト

### 10.2 結合テスト
- 案件JSON読み込み → エンジン判定 → UI表示の一貫性
- 判定ボタン3種の結果遷移

### 10.3 E2E（Playwright）
- ケース選択→証言確認→可視化切替→判定→結果表示
- レスポンシブ時の崩れ検知（960幅）

---

## 11. 受け入れ基準（Acceptance Criteria）

1. 10案件すべてで、内部正答データに対し監査エンジンの自動判定が一致する。
2. プレイヤーが誤判定した場合、最低1つの根拠付きフィードバックが表示される。
3. 主要ブラウザ（Chrome最新）で60fps近傍（可視化画面）を維持。
4. 初回ロード2秒以内（ローカル/静的配信前提）。

---

## 12. 将来拡張（v1以降）
- LLMによる証言バリエーション自動生成（同一真相で言い回しのみ変化）。
- 事件分岐（判定による次案件変化）。
- 日次チャレンジとリプレイ共有。

